18 ВАРИАНТ




CREATE OR ALTER FUNCTION dbo.TeacherLessons()
RETURNS TABLE
AS
RETURN
(
    WITH УрокиУчителей AS (
        SELECT 
            r1.Учитель,
            r1.[День недели],
            r1.[Номер урока],
            LAG(r1.[Номер урока]) OVER (
                PARTITION BY r1.Учитель, r1.[День недели] 
                ORDER BY r1.[Номер урока]
            ) AS ПредыдущийУрок
        FROM R1 r1
        WHERE NOT EXISTS (
            SELECT 1 
            FROM R3 r3 
            WHERE r3.Учитель = r1.Учитель 
            AND r3.выходной = r1.[День недели]
        )
    ),
    ГруппыУроков AS (
        SELECT 
            Учитель,
            [День недели],
            [Номер урока],
            SUM(CASE WHEN [Номер урока] - ПредыдущийУрок > 1 OR ПредыдущийУрок IS NULL 
                     THEN 1 ELSE 0 END) OVER (
                PARTITION BY Учитель, [День недели] 
                ORDER BY [Номер урока]
            ) AS ГруппаИд
        FROM УрокиУчителей
    )
    SELECT 
        Учитель,
        [День недели],
        MIN([Номер урока]) AS [Номер первого урока],
        MAX([Номер урока]) AS [Номер последнего урока],
        COUNT(*) AS [Количество уроков],
        (MAX([Номер урока]) - MIN([Номер урока]) + 1) - COUNT(*) AS [Количество окон]
    FROM ГруппыУроков
    GROUP BY Учитель, [День недели], ГруппаИд
);






SELECT * FROM dbo.TeacherLessons()
ORDER BY Учитель, [День недели], [Номер первого урока];




CREATE OR ALTER PROCEDURE dbo.FindFreePerson
AS
BEGIN
    SET NOCOUNT ON;
    
    -- Сначала находим всех редакторов
    WITH ВсеРедакторы AS (
        SELECT DISTINCT
            с.[Табельный номер],
            с.ФИО
        FROM Сотрудники с
        LEFT JOIN Книги к ON к.[Ответственный редактор] = с.[Табельный номер]
        LEFT JOIN [Книги-Редакторы] кр ON кр.[Код редактора] = с.[Табельный номер]
        WHERE к.[Ответственный редактор] IS NOT NULL 
           OR кр.[Код редактора] IS NOT NULL
    ),
    ЗанятыеРедакторы AS (
        SELECT 
            р.[Табельный номер],
            MIN(к.[Дата выхода]) AS [Ближайшая дата выхода],
            MIN(DATEDIFF(DAY, GETDATE(), к.[Дата выхода])) AS [Дней до ближайшего выхода]
        FROM ВсеРедакторы р
        LEFT JOIN Книги к ON к.[Ответственный редактор] = р.[Табельный номер]
        WHERE к.[Дата выхода] > GETDATE()  -- Только книги, которые еще не вышли
        GROUP BY р.[Табельный номер]
        
        UNION
        
        SELECT 
            р.[Табельный номер],
            MIN(к.[Дата выхода]) AS [Ближайшая дата выхода],
            MIN(DATEDIFF(DAY, GETDATE(), к.[Дата выхода])) AS [Дней до ближайшего выхода]
        FROM ВсеРедакторы р
        INNER JOIN [Книги-Редакторы] кр ON кр.[Код редактора] = р.[Табельный номер]
        INNER JOIN Книги к ON к.[№ контракта] = кр.[№ контракта]
        WHERE к.[Дата выхода] > GETDATE()
        GROUP BY р.[Табельный номер]
    ),
    РедакторыСоСтатусом AS (
        SELECT 
            р.[Табельный номер],
            р.ФИО,
            CASE 
                WHEN зр.[Табельный номер] IS NULL THEN 'Свободен'
                ELSE 'Занят'
            END AS [Статус],
            зр.[Ближайшая дата выхода],
            зр.[Дней до ближайшего выхода]
        FROM ВсеРедакторы р
        LEFT JOIN ЗанятыеРедакторы зр ON зр.[Табельный номер] = р.[Табельный номер]
    )
    -- Выбираем самого свободного редактора
    SELECT TOP 1 
        [Табельный номер] AS [Табельный номер самого свободного редактора]
    FROM РедакторыСоСтатусом
    ORDER BY 
        CASE [Статус] 
            WHEN 'Свободен' THEN 1
            ELSE 2
        END ASC,  -- Сначала свободные
        [Дней до ближайшего выхода] ASC;  -- Потом по минимальному сроку до выхода
END;




EXEC dbo.FindFreePerson






CREATE OR ALTER TRIGGER dbo.NoMoreClasses
ON R5
AFTER INSERT, UPDATE
AS
BEGIN
    SET NOCOUNT ON;
    
    -- Проверяем, есть ли учитель, который пытается стать классным руководителем более чем у одного класса
    IF EXISTS (
        SELECT [Классный руководитель]
        FROM (
            -- Объединяем новые записи (INSERTED) со старыми (R5)
            SELECT [Классный руководитель]
            FROM inserted
            
            UNION ALL
            
            SELECT [Классный руководитель]
            FROM R5 r
            WHERE NOT EXISTS (
                -- Исключаем классы, которые обновляются
                SELECT 1 
                FROM inserted i 
                WHERE i.Класс = r.Класс
            )
        ) AS ВсеКлассныеРуководители
        WHERE [Классный руководитель] IS NOT NULL  -- Учитываем только записи, где указан руководитель
        GROUP BY [Классный руководитель]
        HAVING COUNT(*) > 1  -- Учитель не может быть руководителем более чем у одного класса
    )
    BEGIN
        -- Откатываем транзакцию и выводим сообщение об ошибке
        ROLLBACK TRANSACTION;
        
        DECLARE @Сообщение NVARCHAR(500);
        SET @Сообщение = N'Ошибка: Учитель не может быть классным руководителем более чем у одного класса.';
        
        -- Находим конкретного учителя, который нарушает правило
        DECLARE @Нарушитель NVARCHAR(100);
        SELECT TOP 1 @Нарушитель = [Классный руководитель]
        FROM (
            SELECT [Классный руководитель]
            FROM inserted
            
            UNION ALL
            
            SELECT [Классный руководитель]
            FROM R5 r
            WHERE NOT EXISTS (
                SELECT 1 
                FROM inserted i 
                WHERE i.Класс = r.Класс
            )
        ) AS ВсеКлассныеРуководители
        WHERE [Классный руководитель] IS NOT NULL
        GROUP BY [Классный руководитель]
        HAVING COUNT(*) > 1;
        
        IF @Нарушитель IS NOT NULL
        BEGIN
            SET @Сообщение = @Сообщение + N' Учитель "' + @Нарушитель + N'" уже является классным руководителем другого класса.';
        END
        
        RAISERROR(@Сообщение, 16, 1);
        RETURN;
    END
END;


 INSERT INTO R5 (Класс, [Классный руководитель]) 
VALUES (8, N'Петров');